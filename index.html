---
layout: main_page
---

<div class="container-fluid">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">File Tree</h3>
                </div>
                <div class="card-body" style="padding: 2px">
                    <div id="tree-view"></div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">View</h3>
                </div>
                <div class="card-body" style="padding: 0">
                    <iframe src="" title="" style="width: 100%; height: 500px; border: none"></iframe>
                </div>
            </div>

            <div class="card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">Files</h3>
                </div>
                <div class="card-body" style="padding: 0">

                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Suggested Prerequisites</h3>
                </div>
                <div class="card-body" style="padding: 0">

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function main() {
        // Load assets/catalogue_index.txt where each line is string in list
        const response = await fetch('{{ site.baseurl }}/assets/catalogue_index.txt');
        const data = await response.text();
        let filesFlat = data.split('\n');
        filesFlat = filesFlat.filter(line => line.length > 0);
        console.log(filesFlat);

        // Convert flat list into a nested list
        const hierarchy = filesFlat.reduce(function (hier, path) {
            let x = hier;
            path.split('/').forEach(function (item) {
                if (!x[item]) {
                    x[item] = {};
                }
                x = x[item];
            });
            x.path = path;
            return hier;
        }, {});
        console.log(hierarchy); // nested list {dir: {dir: dir, dir2: {...}}}

        let iframe = document.querySelector('iframe');
        // Recursive function to populate #tree-view using nested <ul>s and <li>s
        function populateTree(ul, hierarchy) {
            for (let key in hierarchy) {
                if (key === 'path' || key.startsWith("index.")) {
                    continue;
                }
                let li = document.createElement('li');
                let a = document.createElement('a');
                a.href = "{{ site.baseurl }}" + '/#/' + hierarchy[key].path;
                a.innerText = key;

                // On click, change iframe preview
                a.addEventListener('click', function () {
                    iframe.src = "{{ site.baseurl }}/" + hierarchy[key].path.replace(".md", ".html");
                });

                li.appendChild(a);
                ul.appendChild(li);
                if (hierarchy[key] !== undefined && typeof hierarchy[key] === 'object') {
                    // If a child is a numbas-manifest.json ignore all children
                    if (hierarchy[key]["numbas-manifest.json"] !== undefined) {
                        continue;
                    }

                    // If no index in the directory, don't update the iframe when directory clicked
                    if(Object.keys(hierarchy[key]).length !== 1 && hierarchy[key]["index.html"] === undefined && hierarchy[key]["index.md"] === undefined) {
                        // Remove event listeners from Element and add new click listener
                        console.log(hierarchy[key]);
                        let aNew = a.cloneNode(true)
                        aNew.addEventListener('click', function () {
                            iframe.src = "";
                        });

                        a.replaceWith(aNew);
                    }

                    let ul2 = document.createElement('ul');
                    li.appendChild(ul2);
                    populateTree(ul2, hierarchy[key]);
                }
            }
        }

        // Populate #tree-view
        let treeView = document.getElementById('tree-view');
        let ul = document.createElement('ul');
        treeView.appendChild(ul);
        populateTree(ul, hierarchy['catalogue']);
    }

    main();
</script>

